"use strict";var _createClass=function(){function e(t,i){for(var s=0;s<i.length;s++){var e=i[s];e.enumerable=e.enumerable||!1,e.configurable=!0,"value"in e&&(e.writable=!0),Object.defineProperty(t,e.key,e)}}return function(t,i,s){return i&&e(t.prototype,i),s&&e(t,s),t}}();function _classCallCheck(t,i){if(!(t instanceof i))throw new TypeError("Cannot call a class as a function")}var Brush=function(){function e(t){var i=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,s=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;_classCallCheck(this,e),this.tickAlpha=1,this.ctx=t,this.x=i,this.y=s,this.color="black",this.isActive=!1,this.init()}return _createClass(e,[{key:"init",value:function(){this.color="hsl("+Math.floor(360*Math.random())+", 80%, 70%)",this.decAlpha=.05*Math.random()+.005,this.drops=[],this.radius=Math.floor(5*Math.random()+1);for(var t=0;t<30;t++){var i=Math.random()*(2*Math.PI),s=this.x+Math.cos(i)*this.radius,e=this.y+Math.sin(i)*this.radius;this.drops[t]={angle:i,distance:Math.floor(30*Math.random()+2),radius:3*Math.random()+.8,lineWidth:1.5*Math.random(),x:s,y:e,startX:s,startY:e}}}},{key:"start",value:function(){this.tickAlpha=1,this.isActive=!0}},{key:"draw",value:function(){if(this.isActive){if(this.tickAlpha-=this.decAlpha,this.tickAlpha<=.01)return this.isActive=!1,this.x=Math.floor(300*Math.random()+350),this.y=Math.floor(300*Math.random()+150),void this.init();this.ctx.save(),this.ctx.globalAlpha=this.tickAlpha,this.circleShape(this.x,this.y,this.radius);for(var t=void 0,i=void 0,s=0;s<this.drops.length;s++)t=this.x+Math.cos(this.drops[s].angle)*this.drops[s].distance+5,i=this.y+Math.sin(this.drops[s].angle)*this.drops[s].distance+5,this.drops[s].x-=(this.drops[s].x-t)/2,this.drops[s].y-=(this.drops[s].y-i)/2,this.circleShape(this.drops[s].x,this.drops[s].y,this.drops[s].radius);this.ctx.restore()}}},{key:"circleShape",value:function(t,i,s){this.ctx.beginPath(),this.ctx.arc(t,i,s,0,2*Math.PI,!1),this.ctx.fillStyle=this.color,this.ctx.fill()}}]),e}(),AudioAnalyser=function t(i){_classCallCheck(this,t),this.audioCtx=new(window.AudioContext||window.webkitAudioContext),this.analyser=this.audioCtx.createAnalyser(),this.bufferLength=this.analyser.frequencyBinCount,this.dataArray=new Uint8Array(this.bufferLength),this.audioSourceNode=this.audioCtx.createMediaElementSource(i),this.analyser.fftSize=64,this.analyser.getByteFrequencyData(this.dataArray),this.audioSourceNode.connect(this.analyser),this.analyser.connect(this.audioCtx.destination)},HipHopText=function(){function s(t){var i=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"label";_classCallCheck(this,s),this.ctx=t,this.text=i,this.init()}return _createClass(s,[{key:"init",value:function(){this.color="black",this.x=Math.floor(220*Math.random()+400),this.y=Math.floor(400*Math.random()+150),this.isActif=!1,this.life=Math.floor(5*Math.random()+3),this.scale=.85*Math.random()+.7}},{key:"draw",value:function(){this.isActif&&(this.life-=.1,this.life<=0?this.init():(this.ctx.save(),this.ctx.font="33px undergroundregular",this.ctx.textAlign="center",this.ctx.fillStyle=this.color,this.ctx.translate(this.x,this.y),this.ctx.rotate(-Math.floor(5*Math.random())*Math.PI/180),this.ctx.scale(this.scale,this.scale),this.ctx.fillText(this.text,-5+Math.floor(5*Math.random()),-5+Math.floor(5*Math.random())),this.ctx.lineWidth=1.5,this.ctx.strokeStyle="#E2CEBC",this.ctx.strokeText(this.text,-10+Math.floor(10*Math.random()),-10+Math.floor(10*Math.random())),this.ctx.restore()))}}]),s}(),ThresoldVideo=function(){function a(t,i,s,e){_classCallCheck(this,a),this.thresold=e,this.width=i,this.height=s,this.source=t,this.canvas_temp=document.createElement("canvas"),this.canvas_temp.style.backgroundColor="white",this.canvas_temp.width=i,this.canvas_temp.height=s,this.ctx_temp=this.canvas_temp.getContext("2d"),this.rgb=[0,0,0],this.drawVideoThresold()}return _createClass(a,[{key:"thresoldData",value:function(t){for(var i=0;i<t.data.length;i+=4)t.data[i]<this.thresold||t.data[i+1]<this.thresold||t.data[i+2]<this.thresold?(t.data[i]=this.rgb[0],t.data[i+1]=this.rgb[1],t.data[i+2]=this.rgb[2]):t.data[i+3]=0}},{key:"drawVideoThresold",value:function(){this.ctx_temp.drawImage(this.source,0,0,this.width,this.height),this.bmpData=this.ctx_temp.getImageData(0,0,this.width,this.height),this.thresoldData(this.bmpData),this.ctx_temp.putImageData(this.bmpData,0,0)}}]),a}(),Main=function(){function s(){var e=this;_classCallCheck(this,s),this.audioInfo=document.querySelector("#audioInfo>div"),this.sound=document.querySelector("#sound"),this.container=document.querySelector("#container"),this.image=document.querySelector("#wall"),this.source1=document.querySelector("#source1"),this.source1.src="https://media.giphy.com/media/X8yeP7BkK4zfasdfF0/giphy.mp4",this.source2=document.querySelector("#source2"),this.source2.src="https://media.giphy.com/media/MMFdUyTV6cqVG/giphy.mp4",this.canvas=document.querySelector("#output"),this.ctx=this.canvas.getContext("2d"),this.canvas.width=960,this.canvas.height=640,this.isLocked=!1,this.rgb=[0,0,0],this.brushers=[];for(var t=0;t<16;t++){var i=new Brush(this.ctx,Math.floor(500*Math.random()+280),Math.floor(300*Math.random()+100));this.brushers.push(i)}this.popText=[new HipHopText(this.ctx,"hip hop"),new HipHopText(this.ctx,"yeah"),new HipHopText(this.ctx,"groove"),new HipHopText(this.ctx,"break"),new HipHopText(this.ctx,"dance")],this.displayGraffiti(),this.audioInfo.addEventListener("click",function(t){var i=e.source1.videoWidth,s=e.source1.videoWidth;e.tVideo1=new ThresoldVideo(e.source1,i,s,120),e.tVideo2=new ThresoldVideo(e.source2,i,s,30),e.currentVideo=e.tVideo1,e.audioInfo.parentNode.style.display="none",e.audioAnalyser=new AudioAnalyser(e.sound),e.displayAll()}),this.sound.addEventListener("ended",function(t){e.currentVideo.source.pause(),e.isLocked=!1,clearTimeout(e.timeoutVideo)},!1),this.canvas.addEventListener("click",function(t){e.isLocked?(e.sound.pause(),e.currentVideo.source.pause(),e.isLocked=!1,clearTimeout(e.timeoutVideo)):(e.timeoutVideo=setTimeout(function(){return e.changeSourceSRC()},5e3),e.isLocked=!0,e.sound.play(),e.currentVideo.source.play(),e.loop())})}return _createClass(s,[{key:"changeSourceSRC",value:function(){var t=this;this.isLocked&&(this.currentVideo.source===this.tVideo1.source?(this.currentVideo.source.pause(),this.currentVideo=this.tVideo2):(this.currentVideo.source.pause(),this.currentVideo=this.tVideo1),this.currentVideo.source.play(),this.timeoutVideo=setTimeout(function(){return t.changeSourceSRC()},Math.floor(8e3*Math.random()+3e3)))}},{key:"displayVideo",value:function(){this.currentVideo.drawVideoThresold(),this.ctx.drawImage(this.currentVideo.canvas_temp,280,100)}},{key:"displayBrushers",value:function(){if(this.audioAnalyser){this.audioAnalyser.analyser.getByteTimeDomainData(this.audioAnalyser.dataArray);for(var t=void 0,i=0;i<this.audioAnalyser.bufferLength;i++)80<(t=this.audioAnalyser.dataArray[i]/2)&&.85<Math.random()&&this.popText[i]&&(this.popText[i].color="rgb("+this.rgb[0]+", "+this.rgb[1]+" , "+this.rgb[2]+")",this.popText[i].isActif=!0),70<t&&(.995<Math.random()&&(this.rgb[0]=Math.floor(200*Math.random()),this.rgb[1]=Math.floor(200*Math.random()),this.rgb[2]=Math.floor(200*Math.random()),this.currentVideo.rgb=this.rgb),this.brushers[i]&&!this.brushers[i].isActive&&this.brushers[i].start()),this.brushers[i]&&this.brushers[i].draw(),this.popText[i]&&this.popText[i].isActif&&this.popText[i].draw()}}},{key:"displayGraffiti",value:function(){this.ctx.save(),this.ctx.globalAlpha=.5,this.ctx.shadowBlur=15,this.ctx.shadowColor="black",this.ctx.font="33px undergroundregular",this.ctx.fillStyle="black",this.ctx.translate(150,150),this.ctx.rotate(-5*Math.PI/180),this.ctx.fillText("click",20,40),this.ctx.fillText("where",8,80),this.ctx.fillText("you want",0,120),this.ctx.restore(),this.ctx.save(),this.ctx.globalAlpha=.5,this.ctx.shadowBlur=15,this.ctx.shadowColor="black",this.ctx.font="20px undergroundregular",this.ctx.fillStyle="black",this.ctx.translate(800,450),this.ctx.rotate(-4*Math.PI/180),this.ctx.textAlign="center",this.ctx.fillText("freestyle",0,0),this.ctx.fillText("by oggoelement",7,20),this.ctx.restore()}},{key:"displayAll",value:function(){this.ctx.drawImage(this.image,0,0),this.displayGraffiti(),this.displayBrushers(),this.ctx.save(),this.ctx.globalAlpha=.8,this.ctx.globalCompositeOperation="color-burn",this.displayVideo(),this.ctx.restore()}},{key:"loop",value:function(){this.isLocked&&(requestAnimationFrame(this.loop.bind(this)),this.ctx.clearRect(0,0,960,640),this.displayAll())}}]),s}();window.onload=function(){new Main};